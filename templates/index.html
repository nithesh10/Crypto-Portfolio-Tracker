<!-- index.html -->
{% extends "base.html" %}

{% block title %}Candlestick Chart{% endblock %}

{% block navigation %}
    <div>
        <a href="/logout">Logout</a>
    </div>
{% endblock %}

{% block content %}
    <!-- Add your dashboard content here -->
    <div class="container">
        <div id="chart-section">
            <div id="candlestick-chart"></div>
        </div>
        <div id="watchlist-section" class="watchlist-container">
            <h2>
                Watchlist
                <!-- Add your watchlist content here or use Flask/Jinja2 to render the watchlist data -->
                <form method="POST" style="display: inline;">
                    {{ watchlist_form.hidden_tag() }}
                    {{ watchlist_form.crypto(style='width:50%; display:inline;') }}
                    {{ watchlist_form.submit(style='display:inline;') }}
                </form>
            </h2>
            <ul id="watchlist-items">
                {% for crypto in watchlist %}
                    <li data-crypto="{{ crypto.crypto_name }}">{{ crypto.crypto_name }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div>
        <label for="timeline">Select Timeline:</label>
        <select id="timeline" onchange="updateChart()">
            <option value="5">5 minutes</option>
            <option value="15">15 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">1 hour</option>
            <option value="240">4 hours</option>
            <option value="720">12 hours</option>
            <option value="D">Daily</option>
            <option value="W">Weekly</option>
            <option value="M">Monthly</option>
        </select>
    </div>

    <script>

        function updateChartWithCrypto(cryptoName, selectedTimeline) {
            fetch(`/candlestick_data?crypto=${cryptoName}&timeline=${selectedTimeline}`)
                .then(response => response.json())
                .then(data => {
                    const trace = {
                        x: data.map(d => d.times),
                        open: data.map(d => d.open),
                        high: data.map(d => d.high),
                        low: data.map(d => d.low),
                        close: data.map(d => d.close),
                        type: 'candlestick',
                        name: 'Candlestick Chart',
                    };

                    const layout = {
                        title: `Candlestick Chart for ${cryptoName} - ${selectedTimeline} minutes`,
                        xaxis: {
                            rangeslider: {
                                visible: false
                            }
                        },
                        yaxis: {
                            title: 'Price',
                            fixedrange: true
                        }
                    };

                    const figure = {
                        data: [trace],
                        layout: layout
                    };

                    Plotly.newPlot('candlestick-chart', figure);
                    
                });
                lastSelectedCrypto = cryptoName; 
        }

        // Attach the event listener to watchlist items
        document.getElementById("watchlist-items").addEventListener("click", handleWatchlistItemClick);
        function updateChart() {
            const selectedCrypto = document.querySelector("#watchlist-items li.active");
            const selectedCryptoName = selectedCrypto ? selectedCrypto.dataset.crypto : "BTCUSDT";
            const selectedTimeline = event.target.value;
            updateChartWithCrypto(lastSelectedCrypto, selectedTimeline);
        }

        function handleWatchlistItemClick(event) {
            const cryptoName = event.target.dataset.crypto;
            if (cryptoName) {
                const selectedTimeline = document.getElementById("timeline").value;
                updateChartWithCrypto(cryptoName, selectedTimeline);
            }
        }

        // Initial chart load
        updateChartWithCrypto("BTCUSDT", "5"); // You can set the default crypto and timeline here
    </script>
{% endblock %}
